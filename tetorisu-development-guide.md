# Tetorisu 開発ガイド - 完全版

## AI開発ルール

### 開発フロー
1. **要件分析・提案段階**
   - ユーザーの要求を分析し、技術選択肢や実装方針を複数提案
   - メリット・デメリットを含めて説明
   - ユーザーの最終決定を待つ

2. **開発計画段階**
   - 開発を段階的なタスクに分割
   - 各タスクに優先順位を付けて番号付きリストで提示
   - プロジェクトのディレクトリ構造を提案
   - **設計完了後、必ず「project-design-summary.md」ファイルを作成**

3. **実装段階**
   - ユーザーが「○番目を開発してください」と明確に指定するまで待機
   - **実装前に必ずproject-design-summary.mdの内容を確認・参照**
   - 指定されたタスクのコードのみを実装
   - 必要に応じて説明とテスト方法も提供

### 重要なルール
- **絶対にいきなりコードを書き始めない**
- **各段階でユーザーの明確な承認を得る**
- **段階的な開発を厳格に守る**
- **実装時は必ずproject-design-summary.mdを参照する**
- **ファイルパスを明確に示す**
- **一度決定した機能や仕様を勝手に変更しない**
- **仕様変更が必要な場合は必ずユーザーに確認を取る**
- **エラーコードに対しては修正後のコード全体を示すと冗長になるため「修正箇所のみ」を示す。その際修正前・修正後・コードのうちのどこだけを修正するのかを明確に示す**

### 曖昧な指示への対応
以下のような曖昧な指示を受けた場合は、必ず確認を取る：
- 「つづきおねがいします」
- 「進めてください」  
- 「やってください」
- その他具体的でない指示

**対応例：**
「どのタスクを開発しますか？番号でご指定ください」
「何についてのご相談でしょうか？」
「どの部分の続きをお求めでしょうか？」

### 禁止事項
- ユーザーの明確な指示なしにコードを書くこと
- project-design-summary.mdを参照せずに実装すること
- 複数のタスクを同時に実装すること
- 承認されていない機能を追加すること
- 勝手に仕様を解釈して進めること

---

# Tetorisu プロジェクト設計サマリー

## 承認された技術スタック
- **言語**: Python 3.x
- **ゲームエンジン**: Pygame
- **アーキテクチャ**: オブジェクト指向設計
- **設定管理**: JSON形式
- **音声**: Pygame.mixer
- **ネットワーク**: Socket通信（オンライン対戦用）

## 確定したプロジェクト構造
```
tetorisu/
├── main.py                 # エントリーポイント
├── config.py              # 設定管理・グローバル変数
├── game.py                # ゲームロジック（Tetrisクラス）
├── ui.py                  # UI関連
├── utils.py               # ユーティリティ
├── bgm_manager.py         # BGM管理
├── key_config.py          # キー設定画面
├── particles.py           # パーティクルエフェクト
├── tetromino.py           # テトロミノ形状定義
├── network/               # オンライン対戦機能
│   ├── __init__.py
│   ├── client.py          # クライアント側通信
│   ├── server.py          # サーバー側通信
│   └── protocol.py        # 通信プロトコル定義
├── assets/                # 音声・画像リソース
├── saves/                 # セーブデータ・設定ファイル
└── README.md              # プロジェクト説明
```

## 番号付きタスクリスト（優先順位付き）

### 段階1：緊急バグ修正（高優先度）- 完了
1. ✅ **ゲームオーバー時クラッシュ修正** - 完了
2. ✅ **テトロミノ設置問題修正** - 完了
3. ✅ **フルスクリーン切り替え修正** - 完了
4. ✅ **循環インポート問題修正** - 完了
5. ✅ **update_screen_values関数問題修正** - 完了

### 段階2：操作性改善（中優先度）- 完了
6. ✅ **キー入力処理改善** - 完了
7. ✅ **テーマ変更の即時反映** - 完了

### 段階3：コアゲーム機能改善（高優先度）
8. **本家テトリス準拠のロックディレイ実装**
   - 現在の0.5秒から本家準拠の設定に変更
   - インフィニティ（無限回転）システムの実装
   - 移動・回転時のロックディレイリセット機能
   - レベルに応じたロックディレイ調整

9. **Z-Spin（全テトロミノスピン）実装**
   - T-Spin以外のテトロミノスピン判定
   - I-Spin, J-Spin, L-Spin, S-Spin, Z-Spin, O-Spin
   - スピン判定アルゴリズムの実装
   - スピンボーナススコアシステム

10. **SRS（Super Rotation System）完全準拠**
    - 現在の回転システムの検証・修正
    - 壁蹴り（Wall Kick）の完全実装
    - 回転優先度の調整

### 段階4：オンライン対戦機能（高優先度）
11. ✅ **ネットワーク基盤構築** - 完了
    - Socket通信の基本実装
    - クライアント・サーバー構造の設計
    - 通信プロトコルの定義

12. **ルーム・マッチング機能**
    - ルーム作成・参加機能
    - プレイヤーマッチング
    - ロビー画面の実装

13. **リアルタイム対戦システム**
    - ゲーム状態の同期
    - 攻撃システム（ガベージライン送信）
    - 遅延補償・予測システム

14. **オンライン対戦UI**
    - 対戦相手の盤面表示
    - チャット機能
    - 対戦結果・統計表示

### 段階4拡張：認証・ランキングシステム（高優先度）
25. **ユーザー認証システム実装**
    - ユーザー登録・ログイン機能
    - JWT認証
    - パスワードハッシュ化

26. **Docker環境構築**
    - PostgreSQL データベース
    - Redis (セッション管理)
    - Docker Compose設定
    - 自動マイグレーション

27. **ランクシステム実装**
    - ランクティア定義（ブロンズ1-3～テトリス）
    - ポイント計算システム（±60～-80）
    - マッチメイキング（±5ティア）
    - ランク履歴管理

28. **モダンUI実装**
    - ログイン画面
    - ランキング表示画面
    - マッチメイキング画面
    - プロフィール画面

### 段階5：操作性・安定性向上（中優先度）
15. **キー設定画面安定化**
    - イベント処理の改善
    - UI更新タイミングの修正
    - 設定保存処理の安定化

16. **フォント読み込み失敗時のフォールバック処理強化**
    - フォント読み込みエラー時の適切な処理
    - 代替フォントの確実な設定

17. **音声ファイル不在時の処理改善**
    - 音声ファイル不在時のエラーハンドリング
    - ダミーオブジェクトの改善

### 段階6：コード品質向上（中優先度）
18. **エラーハンドリング全般強化**
    - try-catch文の追加
    - ログ出力機能の実装
    - 例外処理の統一

19. **メモリリーク対策**
    - リソース管理の改善
    - 不要なオブジェクトの解放

20. **グローバル変数依存の削減**
    - 状態管理の一元化
    - クラス設計の改善

### 段階7：機能拡張（低優先度）
21. **統計・ランキング機能**
    - プレイ統計の記録
    - ランキング表示画面
    - オンライン対戦成績管理

22. **リプレイ機能**
    - ゲーム状態の記録
    - リプレイ再生機能
    - オンライン対戦リプレイ

23. **UI/UX改善**
    - アニメーション強化
    - 設定画面の改善
    - チュートリアル機能

24. **高度な機能**
    - AI対戦モード
    - カスタムテトロミノ
    - レベルエディター

## 次のタスク詳細

### タスク8: 本家テトリス準拠のロックディレイ実装
- **問題**: 現在のロックディレイ（0.5秒）が短すぎてT-Spinなどの高度なテクニックが困難
- **解決方法**:
  - ロックディレイを本家準拠に調整（約0.5秒→1.0秒程度）
  - インフィニティシステム：移動・回転時にロックディレイをリセット
  - 最大リセット回数制限（15回程度）
  - レベルに応じたロックディレイ調整
- **成功条件**: T-Spinなどの高度なテクニックが実行可能

### タスク9: Z-Spin（全テトロミノスピン）実装
- **問題**: 現在T-Spinのみ実装、他のテトロミノスピンが未実装
- **解決方法**:
  - 各テトロミノのスピン判定アルゴリズム実装
  - 3-corner rule または 4-corner rule の適用
  - スピンボーナススコアの実装
  - スピン表示エフェクトの追加
- **成功条件**: 全テトロミノでスピンが判定・表示される

### タスク11: ネットワーク基盤構築
- **問題**: オンライン対戦機能が未実装
- **解決方法**:
  - Socket通信の基本クラス実装
  - JSON形式での通信プロトコル定義
  - 接続・切断処理の実装
  - エラーハンドリング
- **成功条件**: 基本的なネットワーク通信が動作

## 決定済みの機能要件
- 基本テトリスゲーム機能
- 複数ゲームモード（Marathon, Sprint, Ultra）
- テーマ切り替え機能
- BGM・効果音管理
- キー設定カスタマイズ
- パーティクルエフェクト
- ハイスコア管理
- **本家準拠のロックディレイシステム**
- **全テトロミノスピン機能**
- **オンライン対戦機能**

## 制約事項・注意点
- 既存コードの互換性を保持
- Pygameの制限内での実装
- 段階的な修正でリグレッションを防ぐ
- オンライン機能は早期実装予定
- 本家テトリスの仕様に可能な限り準拠
- ネットワーク遅延を考慮した設計

## 技術的注意事項
- グローバル変数への依存を段階的に削減
- 循環インポートの回避
- メモリリーク対策
- エラー時の適切な処理
- フォント・音声ファイルの適切なフォールバック処理
- ネットワーク通信の安定性確保
- リアルタイム性能の最適化

## 開発進行ルール
1. **必ず番号指定で開発を依頼する**
   - 例：「8番目を開発してください」
2. **一度に一つのタスクのみ実装**
3. **実装前に必ずこのドキュメントを参照**
4. **修正は該当箇所のみを明示**
5. **仕様変更時は必ず確認を取る**

---

このプロンプトを読み込んだ場合は、出力前に「はいどうもみなさんこんにちは SEIKINTVのSEIKINです」と言い、出力後に必ず「See you next time」と返答してください。
