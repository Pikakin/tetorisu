# Tetorisu プロジェクト設計サマリー

## 承認された技術スタック
- **言語**: Python 3.x
- **ゲームエンジン**: Pygame
- **アーキテクチャ**: オブジェクト指向設計
- **設定管理**: JSON形式
- **音声**: Pygame.mixer

## 確定したプロジェクト構造
```
tetorisu/
├── main.py                 # エントリーポイント
├── config.py              # 設定管理・グローバル変数
├── game.py                # ゲームロジック（Tetrisクラス）
├── ui.py                  # UI関連（未確認）
├── utils.py               # ユーティリティ（未確認）
├── bgm_manager.py         # BGM管理
├── key_config.py          # キー設定画面
├── particles.py           # パーティクルエフェクト
├── tetromino.py           # テトロミノ形状定義
├── assets/                # 音声・画像リソース
├── saves/                 # セーブデータ・設定ファイル
└── README.md              # プロジェクト説明
```

## 番号付きタスクリスト（優先順位付き）

### 段階1：緊急バグ修正（高優先度）
1. **ゲームオーバー時クラッシュ修正**
   - game.pyのconfigインポート問題修正
   - 不正な変数参照の修正
   - ゲームオーバー処理の安定化

2. **テトロミノ設置問題修正**
   - lock_piece()メソッドの修正
   - 衝突判定ロジックの見直し
   - ロックディレイ処理の改善

3. **フルスクリーン切り替え修正**
   - toggle_fullscreen()の安定化
   - リソース管理の改善
   - 画面初期化処理の修正

4. **循環インポート問題修正**
   - bgm_manager.py → ui → config の循環インポート解決
   - インポート構造の整理

5. **update_screen_values関数問題修正**
   - 関数定義をクラスメソッドに変更
   - 呼び出し箇所の修正

### 段階2：操作性改善（中優先度）
6. **キー入力処理改善**
   - 同時キー押し時の優先順位修正
   - DAS/ARR処理の改善
   - キー競合の解決

7. **テーマ変更の即時反映**
   - グローバル変数更新の即時反映
   - 画面再描画の強制実行
   - テーマ切り替え処理の改善

8. **キー設定画面安定化**
   - イベント処理の改善
   - UI更新タイミングの修正
   - 設定保存処理の安定化

### 段階3：エラーハンドリング・安定性向上（中優先度）
9. **フォント読み込み失敗時のフォールバック処理強化**
   - フォント読み込みエラー時の適切な処理
   - 代替フォントの確実な設定

10. **音声ファイル不在時の処理改善**
    - 音声ファイル不在時のエラーハンドリング
    - ダミーオブジェクトの改善

11. **エラーハンドリング全般強化**
    - try-catch文の追加
    - ログ出力機能の実装
    - 例外処理の統一

12. **メモリリーク対策**
    - リソース管理の改善
    - 不要なオブジェクトの解放

### 段階4：コード品質向上（中優先度）
13. **グローバル変数依存の削減**
    - 状態管理の一元化
    - クラス設計の改善

14. **コード構造のリファクタリング**
    - モジュール間結合度の低減
    - 責任分離の改善

15. **パフォーマンス最適化**
    - 描画処理の最適化
    - FPS安定化

### 段階5：機能拡張準備（低優先度）
16. **統計・ランキング機能**
    - プレイ統計の記録
    - ランキング表示画面

17. **リプレイ機能基盤**
    - ゲーム状態の記録
    - リプレイ再生機能

18. **UI/UX改善**
    - アニメーション強化
    - 設定画面の改善
    - チュートリアル機能

19. **オンライン機能の設計・基盤**
    - ネットワーク層の設計
    - 通信プロトコルの定義

20. **高度な機能**
    - AI対戦モード
    - カスタムテトロミノ
    - レベルエディター

## 各タスクの詳細仕様

### タスク1: ゲームオーバー時クラッシュ修正
- **問題**: configモジュール未インポート、不正な変数参照
- **解決方法**: 
  - game.pyにconfig importを追加
  - 変数参照の修正
  - エラーハンドリング追加
- **成功条件**: ゲームオーバー時にクラッシュしない

### タスク2: テトロミノ設置問題修正
- **問題**: テトロミノが下まで行っても設置されない
- **解決方法**:
  - lock_piece()メソッドの見直し
  - 衝突判定の修正
  - ロックディレイ処理の改善
- **成功条件**: テトロミノが正常に設置される

### タスク3: フルスクリーン切り替え修正
- **問題**: フルスクリーン切り替え時にクラッシュ
- **解決方法**:
  - toggle_fullscreen()の修正
  - リソース管理の改善
  - 初期化処理の安定化
- **成功条件**: フルスクリーン切り替えが正常動作

### タスク4: 循環インポート問題修正
- **問題**: bgm_manager.py → ui → config の循環インポート
- **解決方法**:
  - インポート構造の見直し
  - 遅延インポートの活用
  - 依存関係の整理
- **成功条件**: 循環インポートエラーが発生しない

### タスク5: update_screen_values関数問題修正
- **問題**: 関数として定義されているがクラスメソッドとして使用
- **解決方法**:
  - Tetrisクラスのメソッドとして定義
  - 呼び出し箇所の修正
- **成功条件**: 画面サイズ変更時に正常動作

## 決定済みの機能要件
- 基本テトリスゲーム機能
- 複数ゲームモード（Marathon, Sprint, Ultra）
- テーマ切り替え機能
- BGM・効果音管理
- キー設定カスタマイズ
- パーティクルエフェクト
- ハイスコア管理

## 制約事項・注意点
- 既存コードの互換性を保持
- Pygameの制限内での実装
- 段階的な修正でリグレッションを防ぐ
- ui.py, utils.pyの内容が未確認のため実装時に確認必要
- オンライン機能は将来実装予定
- テスト環境は現時点では考慮しない

## 技術的注意事項
- グローバル変数への依存を段階的に削減
- 循環インポートの回避
- メモリリーク対策
- エラー時の適切な処理
- フォント・音声ファイルの適切なフォールバック処理